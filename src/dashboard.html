<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenRouter Token Tracker</title>
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #121923;
        --panel-2: #0f1520;
        --text: #e6eef9;
        --muted: #93a4b7;
        --accent: #4dd0e1;
        --accent-2: #f9c74f;
        --accent-3: #90be6d;
        --danger: #f94144;
        --grid: rgba(255, 255, 255, 0.06);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at 20% 20%, #1c2230 0, #0b0f14 52%);
        color: var(--text);
        font-family: "Space Grotesk", "IBM Plex Sans", "SF Pro Text", "Segoe UI", sans-serif;
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 24px 60px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 28px;
      }

      .title {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: 0.3px;
      }

      .subtitle {
        color: var(--muted);
        margin-top: 6px;
        font-size: 14px;
      }

      .status {
        text-align: right;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.4px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 16px;
      }

      .card {
        background: linear-gradient(135deg, var(--panel), var(--panel-2));
        border: 1px solid var(--grid);
        border-radius: 16px;
        padding: 18px;
        min-height: 140px;
        position: relative;
        overflow: hidden;
      }

      .card h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
      }

      .card .percent {
        font-size: 36px;
        font-weight: 700;
        margin: 0 0 8px 0;
      }

      .card .tokens {
        color: var(--muted);
        font-size: 13px;
      }

      .bar {
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        overflow: hidden;
        margin-top: 14px;
      }

      .bar span {
        display: block;
        height: 100%;
        width: 0%;
        border-radius: 999px;
        transition: width 0.6s ease;
      }

      .accent-cheap {
        background: linear-gradient(90deg, #00b4d8, #48cae4);
      }

      .accent-medium {
        background: linear-gradient(90deg, #f9c74f, #f9844a);
      }

      .accent-frontier {
        background: linear-gradient(90deg, #90be6d, #43aa8b);
      }

      .panel {
        margin-top: 20px;
        background: #0f141d;
        border: 1px solid var(--grid);
        border-radius: 16px;
        padding: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--grid);
      }

      th {
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        font-size: 11px;
      }

      .muted {
        color: var(--muted);
      }

      .legend {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        font-size: 12px;
        color: var(--muted);
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
        margin-right: 6px;
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .status {
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div>
          <div class="title">Token Tracker</div>
          <div class="subtitle">Live usage split across local, medium, and frontier routes.</div>
        </div>
        <div class="status">
          <div id="last-updated">Last update: --</div>
          <div id="total-tracked">Tracked tokens: --</div>
        </div>
      </header>

      <section class="grid">
        <div class="card">
          <h3>Cheap</h3>
          <div class="percent" id="cheap-percent">0%</div>
          <div class="tokens" id="cheap-tokens">0 tokens</div>
          <div class="bar"><span class="accent-cheap" id="cheap-bar"></span></div>
        </div>
        <div class="card">
          <h3>Medium</h3>
          <div class="percent" id="medium-percent">0%</div>
          <div class="tokens" id="medium-tokens">0 tokens</div>
          <div class="bar"><span class="accent-medium" id="medium-bar"></span></div>
        </div>
        <div class="card">
          <h3>Frontier</h3>
          <div class="percent" id="frontier-percent">0%</div>
          <div class="tokens" id="frontier-tokens">0 tokens</div>
          <div class="bar"><span class="accent-frontier" id="frontier-bar"></span></div>
        </div>
      </section>

      <section class="panel">
        <table>
          <thead>
            <tr>
              <th>Route</th>
              <th>Requests</th>
              <th>Prompt Tokens</th>
              <th>Completion Tokens</th>
              <th>Total Tokens</th>
              <th>Usage Tracked</th>
            </tr>
          </thead>
          <tbody id="usage-table">
            <tr>
              <td class="muted" colspan="6">Waiting for usage data...</td>
            </tr>
          </tbody>
        </table>
        <div class="legend">
          <span><span class="dot accent-cheap"></span>Cheap (includes local)</span>
          <span><span class="dot accent-medium"></span>Medium route</span>
          <span><span class="dot accent-frontier"></span>Frontier route</span>
        </div>
      </section>
    </div>

    <script>
      const fmt = new Intl.NumberFormat();
      const routeOrder = ["cheap", "medium", "frontier"];

      function updateCard(idPrefix, percent, totalTokens) {
        const percentEl = document.getElementById(`${idPrefix}-percent`);
        const tokensEl = document.getElementById(`${idPrefix}-tokens`);
        const barEl = document.getElementById(`${idPrefix}-bar`);
        percentEl.textContent = `${percent}%`;
        tokensEl.textContent = `${fmt.format(totalTokens)} tokens`;
        barEl.style.width = `${Math.min(100, Math.max(0, percent))}%`;
      }

      function renderTable(totals) {
        const tbody = document.getElementById("usage-table");
        tbody.innerHTML = "";
        routeOrder.forEach(route => {
          const row = totals[route];
          if (!row) return;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${route}</td>
            <td>${fmt.format(row.requests)}</td>
            <td>${fmt.format(row.promptTokens)}</td>
            <td>${fmt.format(row.completionTokens)}</td>
            <td>${fmt.format(row.totalTokens)}</td>
            <td>${fmt.format(row.withUsage)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function updateStatus(lastUpdated, totalTracked) {
        const updatedEl = document.getElementById("last-updated");
        const totalEl = document.getElementById("total-tracked");
        updatedEl.textContent = `Last update: ${
          lastUpdated ? new Date(lastUpdated).toLocaleTimeString() : "--"
        }`;
        totalEl.textContent = `Tracked tokens: ${fmt.format(totalTracked || 0)}`;
      }

      async function poll() {
        try {
          const res = await fetch("/usage");
          const data = await res.json();
        updateCard("cheap", data.percentages.cheap, data.totals.cheap.totalTokens);
          updateCard("medium", data.percentages.medium, data.totals.medium.totalTokens);
          updateCard("frontier", data.percentages.frontier, data.totals.frontier.totalTokens);
          renderTable(data.totals);
          updateStatus(data.lastUpdated, data.totalTrackedTokens);
        } catch (err) {
          updateStatus(null, 0);
        }
      }

      poll();
      setInterval(poll, 2000);
    </script>
  </body>
</html>
